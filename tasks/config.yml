---
- name: TUTOR | Update config with openedx image
  ansible.builtin.command: "{{ tutor_venv_path }}/{{ tutor_exec_name }} config save --set DOCKER_IMAGE_OPENEDX={{ tutor_openedx_image }}"
  environment:
    TUTOR_ROOT: "{{ tutor_config_path }}"
    TUTOR_PLUGINS_ROOT: "{{ tutor_config_path }}/plugins"
    TUTOR_APP: "{{ tutor_app }}"
  become: true
  become_user: "{{ tutor_user }}"
  changed_when: false  # It woulbe nice to detect change somehow
  when: tutor_openedx_image is defined
  tags:
    - tutor_config

- name: TUTOR | Update config with production settings
  ansible.builtin.command: "{{ tutor_venv_path }}/{{ tutor_exec_name }} config save --set {{ item.key }}={{ item.value | to_yaml }}"
  environment:
    TUTOR_ROOT: "{{ tutor_config_path }}"
    TUTOR_PLUGINS_ROOT: "{{ tutor_config_path }}/plugins"
    TUTOR_APP: "{{ tutor_app }}"
  loop: "{{ tutor_prod_config | combine(tutor_prod_host_config) | dict2items }}"
  become: true
  become_user: "{{ tutor_user }}"
  changed_when: false  # It shouldn't really be changed after install
  tags:
    - tutor_config


# TODO: It can be done in one command
- name: TUTOR | Update config with host-specific secrets
  ansible.builtin.command: "{{ tutor_venv_path }}/{{ tutor_exec_name }} config save --set {{ item.key }}={{ item.value | to_yaml }}"
  environment:
    TUTOR_ROOT: "{{ tutor_config_path }}"
    TUTOR_PLUGINS_ROOT: "{{ tutor_config_path }}/plugins"
    TUTOR_APP: "{{ tutor_app }}"
  loop: "{{ tutor_secrets | dict2items }}"
  no_log: true
  become: true
  become_user: "{{ tutor_user }}"
  changed_when: false  # It shouldn't really be changed after install
  tags:
    - tutor_config
